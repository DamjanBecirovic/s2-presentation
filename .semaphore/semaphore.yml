version: v1.0
name: "\U0001F4A7 Elixir CI Pipeline"
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2004
fail_fast:
  stop:
    when: branch != 'main'
auto_cancel:
  running:
    when: branch != 'main'
  queued:
    when: branch = 'main'
global_job_config:
  prologue:
    commands:
      - checkout
      - sem-version elixir 1.16
      - sem-version erlang 25.3
      - mix local.hex   --force
      - mix local.rebar --force
      - cache restore
blocks:
  - name: "\U0001F4E6 Install & Build"
    task:
      jobs:
        - name: ⚙️ Compile
          commands:
            - mix deps.get
            - mix compile
            - cache store
  - name: "\U0001F58B Format"
    dependencies:
      - "\U0001F4E6 Install & Build"
    task:
      jobs:
        - name: "\U0001F3A8 mix format"
          commands:
            - mix format --check-formatted
  - name: "\U0001F50E Credo"
    dependencies:
      - "\U0001F4E6 Install & Build"
    task:
      jobs:
        - name: "\U0001F50D mix credo"
          commands:
            - mix credo --strict
  - name: "\U0001F510 Sobelow"
    dependencies:
      - "\U0001F4E6 Install & Build"
    task:
      jobs:
        - name: "\U0001F6E1️ mix sobelow"
          commands:
            - mix sobelow --exit
  - name: "\U0001F6E1 Deps Audit"
    dependencies:
      - "\U0001F4E6 Install & Build"
    task:
      jobs:
        - name: "\U0001F6E1️ mix deps.audit"
          commands:
            - mix deps.audit
  - name: "\U0001F4CA Dialyzer"
    dependencies:
      - "\U0001F4E6 Install & Build"
    task:
      jobs:
        - name: "\U0001F9E0 mix dialyzer"
          env_vars:
            - name: MIX_ENV
              value: test
          commands:
            - mix dialyzer --halt-exit-status
  - name: "\U0001F9EA Tests"
    dependencies:
      - "\U0001F4E6 Install & Build"
    task:
      epilogue:
        always:
          commands:
            - '[ -f report.xml ] && test-results publish report.xml'
      jobs:
        - name: "\U0001F9EA Tests-1"
          env_vars:
            - name: MIX_TEST_PARTITION
              value: '1'
          commands:
            - sem-service start postgres 17
            - mix test --color
        - name: "\U0001F9EA Tests-2"
          env_vars:
            - name: MIX_TEST_PARTITION
              value: '2'
          commands:
            - sem-service start postgres 17
            - mix test --color
  - name: "\U0001F680 Docker Deploy"
    dependencies:
      - "\U0001F58B Format"
      - "\U0001F50E Credo"
      - "\U0001F510 Sobelow"
      - "\U0001F6E1 Deps Audit"
      - "\U0001F4CA Dialyzer"
      - "\U0001F9EA Tests"
    run:
      when: branch = 'main'
    task:
      secrets:
        - name: dockerhub
      jobs:
        - name: "\U0001F433 Build & Push"
          commands:
            - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
            - 'docker build -t myapp:${SEMAPHORE_GIT_SHA} .'
            - 'docker tag  myapp:${SEMAPHORE_GIT_SHA} myapp:latest'
            - 'docker push myapp:${SEMAPHORE_GIT_SHA}'
            - 'docker push myapp:latest'
after_pipeline:
  task:
    jobs:
      - name: "\U0001F4CA Merge Reports"
        commands:
          - test-results gen-pipeline-report
