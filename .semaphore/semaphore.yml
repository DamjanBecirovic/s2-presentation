version: v1.0
name: "\U0001F499 Flutter (VM) — Lint • Test • Web build"
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
fail_fast:
  stop:
    when: branch != 'main'
auto_cancel:
  running:
    when: branch != 'main'
  queued:
    when: branch != 'main'
global_job_config:
  env_vars:
    - name: FLUTTER_HOME
      value: $HOME/flutter
    - name: PATH
      value: '$HOME/.pub-cache/bin:$FLUTTER_HOME/bin:$PATH'
    - name: JUNIT_FILE
      value: test-results/junit.xml
  prologue:
    commands:
      - checkout
      - cache restore "pub-cache-$(checksum pubspec.lock)"
      - 'git clone --depth 1 -b stable https://github.com/flutter/flutter.git "$FLUTTER_HOME"'
      - flutter --version
      - flutter doctor -v
      - flutter pub get
      - dart pub global activate junitreport
  epilogue:
    always:
      commands:
        - '[[ -f "$JUNIT_FILE" ]] && test-results publish "$JUNIT_FILE" || true'
blocks:
  - name: "\U0001F9F9 Quality"
    task:
      jobs:
        - name: "\U0001F9FC Format"
          commands:
            - flutter format --set-exit-if-changed .
        - name: "\U0001F50E Analyze"
          commands:
            - flutter analyze .
  - name: "\U0001F9EA Tests (parallel)"
    task:
      jobs:
        - name: "\U0001F9EA Flutter tests (sharded)"
          parallelism: 4
          commands:
            - mkdir -p test-results
            - export SHARD_INDEX=$((SEMAPHORE_JOB_INDEX - 1))
            - echo "Shard $SHARD_INDEX of $SEMAPHORE_JOB_COUNT"
            - |
              flutter test --machine --total-shards $SEMAPHORE_JOB_COUNT --shard-index $SHARD_INDEX | tojunit --output $JUNIT_FILE
  - name: "\U0001F6E1️ Security (pub deps)"
    task:
      jobs:
        - name: "\U0001F6E1️ Pub outdated (informational)"
          commands:
            - dart pub outdated || true
  - name: "\U0001F4E6 Build Web (artifact)"
    dependencies:
      - "\U0001F9EA Tests (parallel)"
    skip:
      when: branch != 'main'
    task:
      jobs:
        - name: "\U0001F310 flutter build web"
          commands:
            - flutter build web --release
            - artifact push job build/web
after_pipeline:
  task:
    jobs:
      - name: "\U0001F4CA Merge test reports"
        commands:
          - test-results gen-pipeline-report
