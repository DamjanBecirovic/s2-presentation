version: v1.0
name: "\U0001F48E Ruby CI Pipeline"
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2204
  containers:
    - name: main
      image: 'registry.semaphoreci.com/ruby:3.2.2-node-browsers'
    - name: postgres
      image: 'registry.semaphoreci.com/postgres:17'
    - name: redis
      image: 'registry.semaphoreci.com/redis:7.0'
fail_fast:
  stop:
    when: branch != 'main'
auto_cancel:
  running:
    when: branch != 'main'
  queued:
    when: branch = 'main'
global_job_config:
  prologue:
    commands:
      - checkout
      - cache restore
blocks:
  - name: "\U0001F6E0 Setup & Cache"
    task:
      jobs:
        - name: Install Gems & JS deps
          commands:
            - yarn install --frozen-lockfile
            - bundle install --deployment --path vendor/bundle
            - gem install --no-document semaphore_test_boosters
            - cache store
    dependencies: []
  - name: "\U0001F5BC️ Webpacker Build"
    task:
      jobs:
        - name: Compile Assets
          commands:
            - cache restore webpacker-assets
            - 'bundle exec rake webpacker:compile'
            - cache store webpacker-assets public/packs
    dependencies:
      - "\U0001F6E0 Setup & Cache"
  - name: "\U0001F50D ESLint & Stylelint"
    task:
      jobs:
        - name: JS / CSS Lint
          commands:
            - yarn run eslint .
            - yarn run stylelint '**/*.scss'
    dependencies:
      - "\U0001F5BC️ Webpacker Build"
  - name: "\U0001F9F9 RuboCop"
    task:
      jobs:
        - name: Ruby Style Check
          commands:
            - bundle exec rubocop
    dependencies:
      - "\U0001F6E0 Setup & Cache"
  - name: "\U0001F6E1️ Brakeman"
    task:
      jobs:
        - name: Static Analysis
          commands:
            - bundle exec brakeman --force
    dependencies:
      - "\U0001F6E0 Setup & Cache"
  - name: "\U0001F6E1️ Bundler Audit"
    task:
      jobs:
        - name: Gem CVE Check
          commands:
            - bundle exec bundle-audit check --update
    dependencies:
      - "\U0001F6E0 Setup & Cache"
  - name: "\U0001F6A6 RSpec Suite"
    task:
      env_vars:
        - name: RAILS_ENV
          value: test
        - name: PGHOST
          value: 127.0.0.1
        - name: PGUSER
          value: postgres
      jobs:
        - name: "\U0001F7E2 RSpec Tests"
          parallelism: 5
          commands:
            - cache restore webpacker-assets
            - 'bundle exec rake db:setup'
            - rspec_booster --job "$SEMAPHORE_JOB_INDEX/$SEMAPHORE_JOB_COUNT" \ --format RspecJunitFormatter --out report.xml --format documentation
      epilogue:
        always:
          commands:
            - '[[ -f report.xml ]] && test-results publish report.xml'
    dependencies:
      - "\U0001F9F9 RuboCop"
      - "\U0001F6E1️ Brakeman"
      - "\U0001F6E1️ Bundler Audit"
      - "\U0001F5BC️ Webpacker Build"
after_pipeline:
  task:
    jobs:
      - name: "\U0001F4CA Merge Results"
        commands:
          - test-results gen-pipeline-report
