version: v1.0
name: "\U0001F680 Laravel CI Pipeline"
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
  containers:
    - name: main
      image: 'registry.semaphoreci.com/php:8.3-apache'
    - name: postgres
      image: 'registry.semaphoreci.com/postgres:17'
    - name: redis
      image: 'registry.semaphoreci.com/redis:7.0'
fail_fast:
  stop:
    when: branch != 'main'
auto_cancel:
  running:
    when: branch != 'main'
  queued:
    when: branch = 'main'
global_job_config:
  prologue:
    commands:
      - checkout
      - cache restore
      - composer install
      - npm ci
blocks:
  - name: "\U0001F6E0 Setup and Cache"
    dependencies: []
    task:
      jobs:
        - name: Install Dependencies
          commands:
            - cache store
  - name: "\U0001F3A8 Assets"
    dependencies:
      - "\U0001F6E0 Setup and Cache"
    task:
      jobs:
        - name: Compile Assets
          commands:
            - npm run build
  - name: "\U0001F50D Code Quality"
    dependencies:
      - "\U0001F6E0 Setup and Cache"
    task:
      jobs:
        - name: Lint and Format
          commands:
            - ./vendor/bin/pint --test
            - ./vendor/bin/phpstan analyze
            - npm run lint
  - name: "\U0001F510 Security Checks"
    dependencies:
      - "\U0001F6E0 Setup and Cache"
    task:
      jobs:
        - name: Security Scan
          commands:
            - composer audit
            - npm audit
  - name: "\U0001F9EA Test Suite"
    dependencies:
      - "\U0001F6E0 Setup and Cache"
    task:
      env_vars:
        - name: APP_ENV
          value: testing
        - name: DB_CONNECTION
          value: pgsql
        - name: DB_HOST
          value: postgres
        - name: REDIS_HOST
          value: redis
      jobs:
        - name: "\U0001F7E2 PHPUnit Tests"
          parallelism: 4
          commands:
            - php artisan test --parallel --coverage-clover=report.xml
      epilogue:
        always:
          commands:
            - '[[ -f report.xml ]] && test-results publish report.xml'
  - name: "\U0001F310 Browser Tests"
    dependencies:
      - "\U0001F9EA Test Suite"
    task:
      jobs:
        - name: Dusk Tests
          commands:
            - 'php artisan dusk:chrome-driver'
            - php artisan serve & sleep 5
            - php artisan dusk
after_pipeline:
  task:
    jobs:
      - name: "Merge Reports \U0001F4CA"
        commands:
          - test-results gen-pipeline-report
