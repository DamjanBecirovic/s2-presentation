version: v1.0
name: ☕ Java Spring CI Pipeline
agent:
  machine:
    type:
      '[object Object]': null
    os_image:
      '[object Object]': null
fail_fast:
  stop:
    when: branch != 'master'
auto_cancel:
  running:
    when: branch != 'master'
  queued:
    when: branch = 'master'
global_job_config:
  prologue:
    commands:
      - checkout
      - sem-version java 17
      - cache restore
blocks:
  - name: ⚙️ Build
    dependencies: []
    task:
      env_vars:
        - name: MAVEN_OPTS
          value: '-Dmaven.repo.local=.m2'
      jobs:
        - name: "\U0001F4E6 Compile and Package"
          commands:
            - 'mvn -q package jmeter:configure -Dmaven.test.skip=true'
            - cache store
  - name: "\U0001F9EA Test"
    dependencies:
      - ⚙️ Build
    task:
      env_vars:
        - name: MAVEN_OPTS
          value: '-Dmaven.repo.local=.m2'
      jobs:
        - name: ✅ Unit Tests
          commands:
            - mvn -q test-compile -Dmaven.test.skip=true
            - mvn test
        - name: "\U0001F517 Integration Tests"
          commands:
            - mvn -q test-compile -Dmaven.test.skip=true
            - mvn test -Pintegration-testing
      epilogue:
        always:
          commands:
            - test-results publish target/surefire-reports/*.xml
  - name: "\U0001F680 Performance Tests"
    dependencies:
      - ⚙️ Build
    task:
      env_vars:
        - name: MAVEN_OPTS
          value: '-Dmaven.repo.local=.m2'
      jobs:
        - name: "\U0001F4CA Benchmark Tests"
          commands:
            - java -version
            - java -jar target/spring-pipeline-demo.jar > /dev/null &
            - sleep 20
            - 'mvn -q jmeter:jmeter'
            - 'mvn jmeter:results'
  - name: "\U0001F433 Dockerize"
    dependencies:
      - "\U0001F680 Performance Tests"
    task:
      env_vars:
        - name: MAVEN_OPTS
          value: '-Dmaven.repo.local=.m2'
        - name: ENVIRONMENT
          value: dev
      jobs:
        - name: "\U0001F4E6 Docker Build and Push"
          commands:
            - 'cache restore spring-pipeline-build-$SEMAPHORE_GIT_BRANCH-$(checksum pom.xml),spring-pipeline-build-$SEMAPHORE_GIT_BRANCH,spring-pipeline-build'
            - mvn -q package -Dmaven.test.skip=true
            - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
            - 'docker pull "$DOCKER_USERNAME"/semaphore-demo-java-spring:latest || true'
            - 'docker build --cache-from "$DOCKER_USERNAME"/semaphore-demo-java-spring:latest --build-arg ENVIRONMENT="${ENVIRONMENT}" -t "$DOCKER_USERNAME"/semaphore-demo-java-spring:latest .'
            - 'docker push "$DOCKER_USERNAME"/semaphore-demo-java-spring:latest'
after_pipeline:
  task:
    jobs:
      - name: "\U0001F4CA Merge Reports"
        commands:
          - test-results gen-pipeline-report
